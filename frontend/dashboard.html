<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>fbnotes - Dashboard</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="css/dashboard.css" rel="stylesheet">
  <!-- Chart.js (defer) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>

   <!-- AOS (Animate on Scroll) -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">


</head>
<body>

  <!-- Sidebar -->
  <nav id="sidebar" class="sidebar" aria-label="Sidebar">
    <div class="brand">
      <h4>fbnotes</h4>
      <button id="closeSidebar" class="close-x" aria-label="Close sidebar">&times;</button>
    </div>

    <ul class="nav flex-column">
      <li class="nav-item"><a class="nav-link active" href="#"><i class="bi bi-house-door-fill"></i> Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" href="bookmarks.html"><i class="bi bi-bookmark"></i> Bookmarks</a></li>
      <li class="nav-item"><a class="nav-link" href="notes.html"><i class="bi bi-journal-text"></i> Notes</a></li>
      <li class="nav-item"><a class="nav-link" href="tags.html"><i class="bi bi-tags"></i> Tags</a></li>
      <li class="nav-item"><a class="nav-link" href="settings.html"><i class="bi bi-gear"></i> Settings</a></li>
    </ul>
  </nav>

  <!-- Main -->
  <main class="main" id="main">
    <div class="topbar mb-3">
      <button id="openSidebar" class="hamburger" aria-label="Open sidebar"><i class="bi bi-list"></i></button>

      <div class="search input-group">
        <input id="globalSearch" class="form-control form-control-sm" placeholder="Search bookmarks, notes, tags..." aria-label="Search">
        <button class="btn btn-sm btn-outline-primary" id="doSearch"><i class="bi bi-search"></i></button>
      </div>

      <div class="ms-auto d-flex align-items-center gap-2">
        <button id="darkToggle" class="btn btn-sm btn-outline-secondary" title="Toggle theme"><i class="bi bi-moon"></i></button>

        <div class="dropdown">
          <a href="#" class="d-flex align-items-center text-decoration-none" id="navUser" data-bs-toggle="dropdown" aria-expanded="false">
            <img id="navAvatar" src="https://via.placeholder.com/36" alt="avatar" class="rounded-circle me-2" width="36" height="36">
            <strong id="navUsername">User</strong>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="profile.html">Profile</a></li>
            <li><a class="dropdown-item" href="settings.html">Settings</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="index.html" id="logoutBtn">Logout</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container-fluid p-0">

      <!-- Overview -->
      <div class="row g-3 mb-4" data-aos="fade-up">
        <div class="col-6 col-md-3">
          <div class="card stats-card">
            <h6>Total Notes</h6>
            <h3 id="metricNotes">—</h3>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card stats-card">
            <h6>Saved Posts</h6>
            <h3 id="metricBookmarks">—</h3>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card stats-card">
            <h6>Categories</h6>
            <h3 id="metricCategories">—</h3>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="card stats-card">
            <h6>Last Synced</h6>
            <h3 id="metricSynced">—</h3>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="row g-3 mb-4" data-aos="fade-up">
        <div class="col-lg-6">
          <div class="card chart-card p-3">
            <div class="section-title">
              <h5 class="mb-0">Notes, last 7 days</h5>
              <small class="text-muted">Trend</small>
            </div>
            <canvas id="notesChart" height="110"></canvas>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card chart-card p-3">
            <div class="section-title">
              <h5 class="mb-0">Bookmarks, last 7 days</h5>
              <small class="text-muted">Trend</small>
            </div>
            <canvas id="bookmarksChart" height="110"></canvas>
          </div>
        </div>
      </div>

      <!-- Content row: recent activity + items -->
      <div class="row g-3">
        <!-- Recent Activity -->
        <div class="col-lg-7" data-aos="fade-up">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Recent activity</h5>
              <small class="text-muted">Latest actions</small>
            </div>

            <div class="table-responsive">
              <table class="table activity-table align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width:1rem">#</th>
                    <th>Action</th>
                    <th>Details</th>
                    <th style="width:180px">When</th>
                  </tr>
                </thead>
                <tbody id="activityBody">
                  <tr><td colspan="4" class="text-center text-muted py-4">Loading…</td></tr>
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
              <small id="activityCount" class="text-muted">—</small>
              <nav><ul class="pagination pagination-sm mb-0" id="activityPager"></ul></nav>
            </div>
          </div>
        </div>

        <!-- Right column: bookmarks & notes quick lists + actions -->
        <div class="col-lg-5">
          <div class="card p-3 mb-3" data-aos="fade-up">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6>Recent bookmarks</h6>
                <small class="text-muted">Latest saved posts</small>
              </div>
              <div><a href="bookmarks.html" class="btn btn-sm btn-outline-primary">Manage</a></div>
            </div>

            <div id="bookmarksList" class="mt-3 cards-grid"></div>
            <div id="bookmarksEmpty" class="text-muted mt-3 d-none">No bookmarks yet.</div>
          </div>

          <div class="card p-3 mb-3" data-aos="fade-up">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6>Recent notes</h6>
                <small class="text-muted">Latest notes</small>
              </div>
              <div><a href="notes.html" class="btn btn-sm btn-outline-primary">Manage</a></div>
            </div>

            <div id="notesList" class="mt-3 cards-grid"></div>
            <div id="notesEmpty" class="text-muted mt-3 d-none">No notes yet.</div>
          </div>

          <div class="card p-3" data-aos="fade-up">
            <h6>Quick actions</h6>
            <div class="d-grid gap-2 mt-2">
              <button id="addNoteBtn" class="btn btn-brand"><i class="bi bi-plus-lg me-2"></i>Add note</button>
              <button id="addBookmarkBtn" class="btn  btn-outline-accent btn-outline-brand"><i class="bi bi-bookmark-plus me-2"></i>Save post</button>
              <button id="manageTagsBtn" class="btn btn-outline-accent btn-outline-brand"><i class="bi bi-tags me-2"></i>Manage categories</button>
            </div>
          </div>

        </div>
      </div>

      <!-- Announcements -->
      <div class="row g-3 mt-1 mb-5" data-aos="fade-up">
        <div class="col-12">
          <div class="card p-3">
            <div class="d-flex justify-content-between">
              <h6 class="mb-0">Announcements</h6>
              <small class="text-muted">News & updates</small>
            </div>
            <ul id="announcementsList" class="mt-3 mb-0 list-unstyled small">
              <li class="text-muted">Loading announcements…</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Floating FAB -->
      <button id="fabAdd" class="fab btn-brand" title="Quick add"><i class="bi bi-pencil-fill fs-5"></i></button>

    </div>
  </main>

  <!-- Mobile bottom nav -->
  <nav class="bottom-nav d-lg-none">
    <a href="#" class="text-center"><i class="bi bi-house-door"></i><div>Home</div></a>
    <a href="bookmarks.html" class="text-center"><i class="bi bi-bookmark"></i><div>Bookmarks</div></a>
    <a href="notes.html" class="text-center"><i class="bi bi-journal-text"></i><div>Notes</div></a>
  </nav>

  <!-- ADD NOTE Modal (lightweight) -->
  <div class="modal fade" id="addNoteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" id="addNoteForm">
        <div class="modal-header">
          <h5 class="modal-title">Add note</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Title</label>
          <input id="noteTitle" class="form-control mb-2" required>
          <label class="form-label">Note</label>
          <textarea id="noteBody" class="form-control mb-2" rows="4" required></textarea>
          <label class="form-label">Category (optional)</label>
          <select id="noteCategory" class="form-select">
            <option value="">— Select —</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
          <button class="btn btn-brand" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- BOOTSTRAP JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script src="/js/api.js" type="module"></script>
  <script src="/js/dashboardLoaders.js" type="module"></script>
  <script src="/js/dashboard.js" type="module"></script>
  <script type="module" src="./js/utils.js"></script>
  <script type="module" src="./js/auth.js"></script>
  <script type="module" src="./js/navbar.js"></script>


  <!-- Dashboard JS -->
  <script>

  // AOS init
  AOS.init({ once: true, duration: 600 });

    /* ===== UI elements ===== */
  const sidebar = document.getElementById('sidebar'), closeSidebar = document.getElementById('closeSidebar'), openSidebar = document.getElementById('openSidebar');
  const darkToggle = document.getElementById('darkToggle'), navUsername = document.getElementById('navUsername'), navAvatar = document.getElementById('navAvatar');
  const metricNotes = document.getElementById('metricNotes'), metricBookmarks = document.getElementById('metricBookmarks'), metricCategories = document.getElementById('metricCategories'), metricSynced = document.getElementById('metricSynced');
  const activityBody = document.getElementById('activityBody'), activityPager = document.getElementById('activityPager'), activityCount = document.getElementById('activityCount');
  const bookmarksList = document.getElementById('bookmarksList'), bookmarksEmpty = document.getElementById('bookmarksEmpty');
  const notesList = document.getElementById('notesList'), notesEmpty = document.getElementById('notesEmpty');
  const announcementsList = document.getElementById('announcementsList');
  const notesChartEl = document.getElementById('notesChart'), bookmarksChartEl = document.getElementById('bookmarksChart');
  const fabAdd = document.getElementById('fabAdd'), addNoteBtn = document.getElementById('addNoteBtn'), addBookmarkBtn = document.getElementById('addBookmarkBtn'), manageTagsBtn = document.getElementById('manageTagsBtn');
  const addNoteModal = new bootstrap.Modal(document.getElementById('addNoteModal')), addNoteForm = document.getElementById('addNoteForm');

    /* ===== sidebar actions ===== */
  openSidebar.addEventListener('click', ()=>{ sidebar.classList.remove('hidden'); sidebar.classList.add('show'); });
  closeSidebar.addEventListener('click', ()=>{ sidebar.classList.add('hidden'); sidebar.classList.remove('show'); });

  /* ===== theme ===== */
  (function initTheme(){ if(localStorage.getItem('fb_dark')==='true'){ document.body.classList.add('dark'); } updateDarkIcon(); })();
  darkToggle.addEventListener('click', ()=>{ const d = document.body.classList.toggle('dark'); localStorage.setItem('fb_dark', d); updateDarkIcon(); });
  function updateDarkIcon(){ const i = darkToggle.querySelector('i'); if(document.body.classList.contains('dark')){ i.classList.remove('bi-moon'); i.classList.add('bi-sun'); } else { i.classList.remove('bi-sun'); i.classList.add('bi-moon'); } }

  /* ===== render helpers ===== */
  function createCardItem({id,title,desc,url,created_at,source}, type='bookmark'){
    const wrapper = document.createElement('div');
    wrapper.className = 'item-card card p-3 mb-2';
    wrapper.innerHTML = `
      <div class="d-flex justify-content-between">
        <div style="flex:1">
          <div class="title">${escapeHtml(title || (url || 'Untitled'))}</div>
          <div class="meta">${escapeHtml(desc || (source||''))}</div>
        </div>
        <div class="ms-3 text-end">
          <small class="text-muted">${fmtWhen(created_at)}</small>
          <div class="mt-2">
            <a href="${type==='bookmark' ? escapeHtml(url||'#') : 'notes.html'}" target="_blank" class="btn btn-sm btn-outline-primary">Open</a>
          </div>
        </div>
      </div>
    `;
    return wrapper;
  }

  /* ===== activity table (paginated) ===== */
  async function loadActivity(page=1){
    try{
      const res = await apiFetch(`/activity/?page=${page}`); // { count, page, page_size, results: [...] }
      const rows = res.results || [];
      activityBody.innerHTML = '';
      if(rows.length===0){ activityBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No recent activity</td></tr>'; activityCount.textContent = '0 total'; renderPager(1,10,0); return; }
      rows.forEach((r,i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="small text-muted">${(res.page-1)*(res.page_size||rows.length)+i+1}</td>
                        <td><strong>${escapeHtml(r.action||'')}</strong></td>
                        <td>${escapeHtml(r.details||'')}</td>
                        <td><small class="text-muted">${fmtWhen(r.timestamp)}</small></td>`;
        activityBody.appendChild(tr);
      });
      activityCount.textContent = (res.count ?? rows.length) + ' total';
      renderPager(res.page || 1, res.page_size || 10, res.count || rows.length);
    }catch(e){
      activityBody.innerHTML = '<tr><td colspan="4" class="text-danger text-center py-4">Failed to load activity</td></tr>'; console.warn(e);
    }
  }

  function renderPager(page = 1, pageSize = 10, total = 0) {
  activityPager.innerHTML = '';
  const pages = Math.max(1, Math.ceil(total / pageSize));

  const makeLi = (p, label, disabled, active) => {
    const li = document.createElement('li');
    li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
    const a = document.createElement('a');
    a.className = 'page-link';
    a.href = '#';
    a.textContent = label;
    a.addEventListener('click', (e) => {
      e.preventDefault();
      if (!disabled && !active) loadActivity(p);
    });
    li.appendChild(a);
    return li;
  };

  activityPager.appendChild(makeLi(page - 1, '‹', page <= 1));
  for (let i = 1; i <= pages; i++) {
    activityPager.appendChild(makeLi(i, i, false, i === page));
  }
  activityPager.appendChild(makeLi(page + 1, '›', page >= pages));
}

  /* ===== add note flow (simple) ===== */
  addNoteBtn.addEventListener('click', ()=> addNoteModal.show());
  fabAdd.addEventListener('click', ()=> addNoteModal.show());
  addNoteForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const title = document.getElementById('noteTitle').value.trim();
    const body = document.getElementById('noteBody').value.trim();
    const category = document.getElementById('noteCategory').value || null;
    if(!title || !body) return alert('Please add both title and note body.');
    try{
      await apiFetch('/notes/', { method:'POST', body:{ title, text: body, category }});
      addNoteModal.hide();
      addNoteForm.reset();
      await Promise.all([ loadMetrics(), loadRecentNotes(), loadActivity(1), loadNotesChart() ]);
      showToast('Note added');
    }catch(e){ console.error(e); alert('Failed to add note.'); }
  });

  /* ===== small util: showToast ===== */
  function showToast(msg){
    const el=document.createElement('div'); el.textContent=msg;
    Object.assign(el.style,{position:'fixed',right:'18px',bottom:'140px',background:'#0f1724',color:'#fff',padding:'.6rem .9rem',borderRadius:'8px',zIndex:1300});
    document.body.appendChild(el); setTimeout(()=>el.remove(),1500);
  }

  /* ===== populate categories select (for add note) ===== */
  async function populateCategorySelect(){
    try{
      const cats = await apiFetch('/categories/');
      const sel = document.getElementById('noteCategory');
      sel.innerHTML = '<option value="">— Select —</option>';
      (cats||[]).forEach(c => { const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o); });
    }catch(e){ console.warn('categories', e); }
  }

  /* ===== populate current user (if /accounts/me/ exists) ===== */
  async function loadCurrentUser(){
    try{
      const me = await apiFetch('/accounts/me/');
      navUsername.textContent = me.username || me.email || 'You';
      if(me.profile_photo) navAvatar.src = me.profile_photo;
    }catch(e){ /* ignore */ }
  }

  /* ===== init ===== */
  (async function init(){
    try{
      await Promise.all([ loadMetrics(), loadNotesChart(), loadBookmarksChart(), loadRecentBookmarks(), loadRecentNotes(), loadActivity(1), loadAnnouncements(), populateCategorySelect(), loadCurrentUser() ]);
    }catch(e){ console.error('init error', e); }
  })();

  /* ===== logout ===== */
  document.getElementById('logoutBtn').addEventListener('click', (ev) => {
    ev.preventDefault(); localStorage.removeItem(tokenKey); localStorage.removeItem('fb_refresh'); window.location.href='login.html';
  });

  /* ===== keyboard search (enter) ===== */
  document.getElementById('globalSearch').addEventListener('keydown', (e) => { if(e.key === 'Enter'){ e.preventDefault(); const q = e.target.value.trim(); window.location.href = '/search.html?q=' + encodeURIComponent(q); } });

  </script>
</body>
</html>
