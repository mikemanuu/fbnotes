<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Save to FB Notes</title>
  <style>body{font-family:Arial;padding:10px}label{display:block;margin-top:8px}</style>
</head>
<body>
  <h4>Save post</h4>
  <div>URL: <span id="url"></span></div>
  <label>Snippet<textarea id="snippet" rows="4" style="width:100%"></textarea></label>
  <label>Tags<input id="tags" style="width:100%"></label>
  <button id="save">Save</button>
  <script>
    document.addEventListener('DOMContentLoaded', async ()=> {
      const [tab] = await chrome.tabs.query({active:true,currentWindow:true});
      document.getElementById('url').innerText = tab.url;
      chrome.scripting.executeScript({target:{tabId:tab.id}, func: () => {
        const sel = window.getSelection().toString().trim();
        if(sel) return sel;
        const p = document.querySelector('p');
        return p ? p.innerText.slice(0,500) : document.body.innerText.slice(0,500);
      }}, (res) => {
        document.getElementById('snippet').value = res[0].result || '';
      });

      document.getElementById('save').addEventListener('click', async ()=>{
        const token = await new Promise(r => chrome.storage.local.get(['jwt'], res => r(res.jwt)));
        const payload = {
          url: tab.url,
          snippet: document.getElementById('snippet').value,
          tags: (document.getElementById('tags').value||'').split(',').map(s=>s.trim()).filter(Boolean)
        };
        fetch('https://yourapp.example.com/api/v1/ext/capture/', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': token ? `Bearer ${token}` : '',
          },
          body: JSON.stringify(payload)
        }).then(r=>r.json()).then(res => {
          alert('Saved: ' + JSON.stringify(res));
        }).catch(e => alert('Error: '+e.message));
      });
    });
  </script>
</body>
</html>
